{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pulse-bi.local/schemas/agent-validation-record.schema.json",
  "title": "Agent Validation Record",
  "description": "Canonical run record for deterministic evidence governance decisions.",
  "type": "object",
  "required": [
    "runId",
    "phase",
    "lane",
    "changeType",
    "evidenceLevel",
    "commitSha",
    "tooling",
    "env",
    "tdd",
    "artifacts",
    "status"
  ],
  "properties": {
    "runId": {
      "type": "string",
      "minLength": 8,
      "description": "Unique run identifier. Common pattern: ISO-8601 timestamp plus suffix."
    },
    "phase": {
      "type": "string",
      "minLength": 1
    },
    "lane": {
      "type": "string",
      "enum": [
        "gate",
        "exploration"
      ]
    },
    "changeType": {
      "type": "string",
      "enum": [
        "ui-feature",
        "api-feature",
        "bugfix",
        "refactor",
        "security",
        "perf",
        "a11y",
        "migration",
        "release"
      ]
    },
    "evidenceLevel": {
      "type": "string",
      "enum": [
        "L0",
        "L1",
        "L2",
        "L3"
      ]
    },
    "commitSha": {
      "type": "string",
      "pattern": "^(git:)?[A-Fa-f0-9]{7,64}$"
    },
    "prRef": {
      "type": "string",
      "minLength": 3
    },
    "tooling": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "env": {
      "type": "object",
      "required": [
        "runtime",
        "packageManager",
        "os"
      ],
      "properties": {
        "runtime": {
          "type": "string",
          "minLength": 2,
          "description": "Primary runtime and version, e.g. node@20.11.1 or python@3.12.2."
        },
        "packageManager": {
          "type": "string",
          "minLength": 2
        },
        "os": {
          "type": "string",
          "minLength": 2
        },
        "tools": {
          "type": "object",
          "description": "Optional language-specific tool versions.",
          "additionalProperties": {
            "type": "string",
            "minLength": 1
          }
        }
      },
      "additionalProperties": false
    },
    "tdd": {
      "type": "object",
      "required": [
        "regressionTestAdded",
        "acceptanceCriteriaCovered"
      ],
      "properties": {
        "regressionTestAdded": {
          "type": "boolean"
        },
        "acceptanceCriteriaCovered": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      },
      "additionalProperties": false
    },
    "artifacts": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "pattern": "^[^\\s].+"
      }
    },
    "status": {
      "type": "string",
      "enum": [
        "pass",
        "fail",
        "blocked"
      ]
    },
    "decisionRefs": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "changeType": {
            "const": "bugfix"
          }
        }
      },
      "then": {
        "properties": {
          "tdd": {
            "properties": {
              "regressionTestAdded": {
                "const": true
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "evidenceLevel": {
            "enum": [
              "L2",
              "L3"
            ]
          }
        }
      },
      "then": {
        "required": [
          "decisionRefs"
        ],
        "properties": {
          "decisionRefs": {
            "minItems": 1
          }
        }
      }
    }
  ],
  "additionalProperties": false,
  "examples": [
    {
      "runId": "2026-02-15T10:00:00Z-abc123",
      "phase": "phase-02",
      "lane": "gate",
      "changeType": "bugfix",
      "evidenceLevel": "L1",
      "commitSha": "git:abcdef1234567890",
      "prRef": "org/repo#123",
      "tooling": [
        "eslint",
        "tsc",
        "vitest"
      ],
      "env": {
        "runtime": "node@20.11.1",
        "packageManager": "pnpm@9.1.0",
        "os": "ubuntu-22.04",
        "tools": {
          "typescript": "5.9.3"
        }
      },
      "tdd": {
        "regressionTestAdded": true,
        "acceptanceCriteriaCovered": [
          "AC-1",
          "AC-2"
        ]
      },
      "artifacts": [
        "evidence/phase-02/unit-junit.xml",
        "evidence/phase-02/coverage/lcov.info",
        "evidence/phase-02/command.log"
      ],
      "status": "pass",
      "decisionRefs": [
        "evidence/phase-02/decision-log.md#entry-04"
      ]
    }
  ]
}
